<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soleron Energy Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            display: block;
            color: #1a1a1a;
            padding: 2vh;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2vh;
            padding: 0 10px;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #e2e8f0;
            color: #64748b;
            transition: all 0.3s ease;
        }

        .status-pill.online {
            background: #dcfce7;
            color: #166534;
        }

        .status-pill.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .refresh-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .refresh-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .refresh-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        .refresh-btn svg {
            width: 16px;
            height: 16px;
            margin-right: 6px;
        }

        .refreshing svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .main-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 3vh;
            margin-bottom: 2vh;
        }

        .flow-container {
            flex: 2;
            display: flex;
            flex-direction: column;
            position: relative;
            justify-content: space-between;
            /* padding: 2vh 0; */
        }

        .top-row {
            display: flex;
            justify-content: center;
            z-index: 2;
        }

        .bottom-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            z-index: 2;
            margin-top: auto;
            /* Push to bottom of flow container */
        }

        /* SVG Lines Layer */
        .lines-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .data-card {
            background: white;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            padding: 1.5vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            z-index: 2;
            min-height: 120px;
        }

        .data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }

        .top-card {
            width: 280px;
            border: 2px solid #3b82f6;
            background: #eff6ff;
        }

        /* Icons removed */
        .card-icon {
            display: none;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 800;
            /* Made bolder */
            color: #0f172a;
            /* Made darker (almost black) */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1vh;
            text-align: center;
        }

        .card-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #0f172a;
            line-height: 1;
            margin-bottom: 0.5vh;
        }

        .card-unit {
            font-size: 1rem;
            color: #64748b;
            font-weight: 500;
        }

        .card-formula {
            font-size: 0.8rem;
            color: #64748b;
            /* Slightly darker */
            margin-top: 0.5vh;
            border-top: 1px dashed #cbd5e1;
            padding-top: 0.5vh;
            width: 100%;
            text-align: center;
            font-weight: 500;
        }

        .status-badge {
            margin-top: 0.5vh;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Status colors */
        .badge-idle {
            background: #f1f5f9;
            color: #64748b;
        }

        .badge-buying {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-selling {
            background: #dcfce7;
            color: #166534;
        }

        .badge-producing {
            background: #dcfce7;
            color: #15803d;
        }

        .extras-container {
            margin-top: 2vh;
            border-top: 1px solid #e2e8f0;
            padding-top: 2vh;
            display: flex;
            flex-direction: column;
            gap: 1.5vh;
        }

        .extras-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-left: 4px;
        }

        .extras-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .mini-card {
            display: flex;
            align-items: center;
            justify-content: center;
            /* Centered since icon is gone */
            padding: 1.5vh;
            background: #f8fafc;
            border-radius: 12px;
            gap: 12px;
            text-align: center;
        }

        .mini-icon {
            display: none;
        }

        .mini-content {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .mini-label {
            font-size: 0.85rem;
            color: #334155;
            /* Darker grey */
            font-weight: 700;
            /* Bolder */
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 4px;
        }

        .mini-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: #0f172a;
        }

        .footer {
            text-align: center;
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: auto;
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            font-size: 1.1rem;
            color: #64748b;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            body {
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
                padding: 10px;
            }

            .container {
                height: 100%;
            }

            .main-display {
                padding: 15px 10px;
                border-radius: 16px;
                margin-bottom: 10px;
            }

            .header {
                margin-bottom: 10px;
            }

            .header h1 {
                font-size: 1.1rem;
            }

            .top-card {
                width: 100%;
                max-width: 180px;
                min-height: 70px;
            }

            .flow-container {
                justify-content: center;
                /* Center items instead of space-between */
                gap: 50px;
                /* Adjusted to 50px */
                flex: 0 1 auto;
                /* Don't force to fill screen if not needed */
            }

            .bottom-row {
                grid-template-columns: repeat(4, 1fr);
                gap: 5px;
                margin-top: 0;
                /* Let flex gap handle it */
            }

            .extras-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .lines-layer {
                display: block;
                /* Enable lines on mobile */
            }

            .data-card {
                min-height: 80px;
                padding: 8px 4px;
            }

            .card-title {
                font-size: 0.65rem;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                width: 100%;
            }

            .card-value {
                font-size: 1.1rem;
            }

            .card-unit {
                font-size: 0.7rem;
            }

            .card-formula {
                font-size: 0.6rem;
                padding-top: 2px;
            }

            .status-badge {
                font-size: 0.6rem;
                padding: 2px 6px;
            }

            .mini-card {
                padding: 8px;
            }

            .mini-label {
                font-size: 0.7rem;
            }

            .mini-value {
                font-size: 0.9rem;
            }

            .extras-container {
                margin-top: 10px;
                padding-top: 10px;
                gap: 8px;
            }

            .header {
                flex-wrap: wrap;
                gap: 10px;
            }

            .header-actions {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .refresh-btn {
                padding: 6px 12px;
                font-size: 0.75rem;
                margin-left: 0;
            }

            .footer {
                margin-top: 10px;
                padding-bottom: 10px;
            }
        }

        /* Flow Animations */
        @keyframes flowAnimation {
            from {
                stroke-dashoffset: 20;
            }

            to {
                stroke-dashoffset: 0;
            }
        }

        @keyframes flowAnimationReverse {
            from {
                stroke-dashoffset: 0;
            }

            to {
                stroke-dashoffset: 20;
            }
        }

        .flow-line {
            stroke-dasharray: 10, 10;
            stroke-width: 3;
            /* Thicker for visibility */
            stroke-linecap: round;
        }

        .flow-up {
            stroke: #22c55e;
            /* Green for producing/discharging up */
            animation: flowAnimationReverse 1s linear infinite;
            /* Bottom to Top */
        }

        .flow-down {
            stroke: #ef4444;
            /* Red for consumption */
            animation: flowAnimation 1s linear infinite;
            /* Top to Bottom */
        }

        .flow-charging {
            stroke: #3b82f6;
            /* Blue for charging */
            animation: flowAnimation 1s linear infinite;
            /* Top to Bottom */
        }

        .flow-idle {
            stroke: #94a3b8;
            /* Darker grey for visibility */
            stroke-dasharray: 5, 5;
            stroke-width: 2;
        }

        /* Login Screen */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 48px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .login-box h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .login-box p {
            font-size: 0.95rem;
            color: #64748b;
            margin-bottom: 32px;
        }

        .login-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
            margin-bottom: 16px;
        }

        .login-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-error {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 12px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* Price Chart Section */
        .chart-section {
            margin: 2vh auto 0;
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 3vh;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2vh;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #0f172a;
        }

        .time-range-buttons {
            display: flex;
            gap: 8px;
        }

        .time-btn {
            padding: 6px 14px;
            background: #f1f5f9;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-btn:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
        }

        .time-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .chart-section {
                padding: 15px;
                margin-top: 10px;
            }

            .chart-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .chart-container {
                height: 300px;
            }

            .time-range-buttons {
                width: 100%;
                justify-content: space-between;
            }

            .time-btn {
                flex: 1;
                padding: 8px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-box">
            <h2>ðŸ”’ Soleron Energy Monitor</h2>
            <p>Sisesta parool juurdepÃ¤Ã¤suks</p>
            <input type="password" id="password-input" class="login-input" placeholder="Parool" autocomplete="off">
            <button id="login-btn" class="login-btn">Sisene</button>
            <div id="login-error" class="login-error">Vale parool!</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Soleron Energy Monitor</h1>
            <div class="header-actions">
                <div id="status" class="status-pill">Connecting...</div>
                <button id="refresh-btn" class="refresh-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    VÃ¤rskenda
                </button>
            </div>
        </div>

        <div class="main-display">
            <div id="loading" class="loading-overlay">Loading system data...</div>

            <div class="flow-container">
                <!-- SVG Lines Layer -->
                <svg class="lines-layer" id="lines-svg">
                    <defs>
                        <!-- Markers for line ends -->
                        <marker id="arrow-up" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto"
                            markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#22c55e" />
                        </marker>
                        <marker id="arrow-down" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto"
                            markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#ef4444" />
                        </marker>
                        <marker id="arrow-charging" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto"
                            markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#3b82f6" />
                        </marker>
                    </defs>
                    <g id="lines-group"></g>
                </svg>

                <div class="top-row">
                    <div class="data-card top-card" id="card-alajaam">
                        <div class="card-title">Alajaam</div>
                        <div class="card-value"><span id="val-alajaam">--</span> <span class="card-unit">kW</span></div>
                        <div class="card-formula">Cons + 2Ã—Car - Solar - Batt</div>
                    </div>
                </div>

                <div class="bottom-row">
                    <div class="data-card" id="card-solar">
                        <div class="card-title">Solar</div>
                        <div class="card-value"><span id="val-solar">--</span> <span class="card-unit">kW</span></div>
                        <div id="status-solar"></div>
                    </div>

                    <div class="data-card" id="card-battery">
                        <div class="card-title">Battery</div>
                        <div class="card-value"><span id="val-battery">--</span> <span class="card-unit">kW</span></div>
                        <div class="card-formula">SoC: <span id="val-soc">--</span>%</div>
                        <div id="status-battery"></div>
                    </div>

                    <div class="data-card" id="card-aeg">
                        <div class="card-title">AEG Kilp</div>
                        <div class="card-value"><span id="val-aeg">--</span> <span class="card-unit">kW</span></div>
                        <div class="card-formula">Consumption + Car</div>
                    </div>

                    <div class="data-card" id="card-rapala">
                        <div class="card-title">RAPALA + PAPINIIDU 13</div>
                        <div class="card-value"><span id="val-rapala">--</span> <span class="card-unit">kW</span></div>
                        <div class="card-formula">Car Only</div>
                    </div>
                </div>
            </div>

            <div class="extras-container">
                <div class="extras-title">Algandmed Soleronist</div>
                <div class="extras-row">
                    <div class="mini-card">
                        <div class="mini-content">
                            <span class="mini-label">MFRR</span>
                            <span class="mini-value" id="val-mfrr">-- â‚¬</span>
                        </div>
                    </div>
                    <div class="mini-card">
                        <div class="mini-content">
                            <span class="mini-label">GRID</span>
                            <span class="mini-value" id="val-grid">-- kW</span>
                        </div>
                    </div>
                    <div class="mini-card">
                        <div class="mini-content">
                            <span class="mini-label">CAR</span>
                            <span class="mini-value" id="val-car">-- kW</span>
                        </div>
                    </div>
                    <div class="mini-card">
                        <div class="mini-content">
                            <span class="mini-label">CONSUMPTION</span>
                            <span class="mini-value" id="val-consumption">-- kW</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer" id="timestamp"></div>
    </div>

    <!-- Price Chart Section -->
    <div class="chart-section" id="chart-section">
        <div class="chart-header">
            <div class="chart-title">ðŸ“Š Hinnad ja Kogused</div>
            <div class="time-range-buttons">
                <button class="time-btn active" data-hours="24">24h</button>
                <button class="time-btn" data-hours="168">7 pÃ¤eva</button>
                <button class="time-btn" data-hours="720">30 pÃ¤eva</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <script>
        // Login functionality
        const PASSWORD = 'mfrr';
        const loginOverlay = document.getElementById('login-overlay');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');

        // Check if already logged in
        if (sessionStorage.getItem('authenticated') === 'true') {
            loginOverlay.classList.add('hidden');
        }

        function attemptLogin() {
            const enteredPassword = passwordInput.value;
            if (enteredPassword === PASSWORD) {
                sessionStorage.setItem('authenticated', 'true');
                loginOverlay.classList.add('hidden');
                loginError.classList.remove('show');
                // Start the app
                fetchEnergyData();
                startPolling();
                // Start inactivity timer
                resetInactivityTimer();
                // Load price chart
                updatePriceChart(24);
            } else {
                loginError.classList.add('show');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        loginBtn.addEventListener('click', attemptLogin);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                attemptLogin();
            }
        });

        // Focus password input on load
        window.addEventListener('load', () => {
            if (!sessionStorage.getItem('authenticated')) {
                passwordInput.focus();
            }
        });

        // Auto-logout after 30 minutes of inactivity
        let inactivityTimer = null;
        const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds

        function resetInactivityTimer() {
            // Only reset if user is authenticated
            if (sessionStorage.getItem('authenticated') !== 'true') return;

            // Clear existing timer
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }

            // Set new timer
            inactivityTimer = setTimeout(() => {
                console.log('Auto-logout due to inactivity');
                sessionStorage.removeItem('authenticated');
                loginOverlay.classList.remove('hidden');
                stopPolling();
                passwordInput.value = '';
                passwordInput.focus();
            }, INACTIVITY_TIMEOUT);
        }

        // Track user activity events (desktop and mobile)
        const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'touchmove', 'click'];
        activityEvents.forEach(event => {
            document.addEventListener(event, resetInactivityTimer, true);
        });

        // Start inactivity timer if already authenticated
        if (sessionStorage.getItem('authenticated') === 'true') {
            resetInactivityTimer();
        }

        // Update connection lines
        // Update connection lines
        function updateLines(data = null) {
            const svg = document.getElementById('lines-svg');
            const linesGroup = document.getElementById('lines-group');
            const topCard = document.querySelector('.top-card'); // Alajaam
            const bottomCards = {
                solar: document.getElementById('card-solar'),
                battery: document.getElementById('card-battery'),
                aeg: document.getElementById('card-aeg'),
                rapala: document.getElementById('card-rapala')
            };

            if (!topCard || !bottomCards.solar) return;

            const containerRect = document.querySelector('.flow-container').getBoundingClientRect();
            const topRect = topCard.getBoundingClientRect();

            // Calculate start point (bottom center of Alajaam)
            const x1 = (topRect.left + topRect.width / 2) - containerRect.left;
            const y1 = (topRect.bottom) - containerRect.top;

            let linesHtml = '';

            // Helper to draw line
            const drawLine = (cardId, type, dataObj) => {
                const card = bottomCards[type];
                if (!card) return;

                const cardRect = card.getBoundingClientRect();
                const x2 = (cardRect.left + cardRect.width / 2) - containerRect.left;
                const y2 = (cardRect.top) - containerRect.top;

                let lineClass = 'flow-line flow-idle';
                let markerStart = '';
                let markerEnd = '';

                if (data) {
                    if (type === 'solar') {
                        // Solar always flows UP if producing
                        if (data.solar && data.solar.load > 0) {
                            lineClass = 'flow-line flow-up';
                            markerStart = 'marker-start="url(#arrow-up)"'; // Arrow at bottom pointing up? No, usually marker-end
                            // SVG markers are tricky with direction. Let's rely on animation direction mostly.
                            // But if we want arrow at Alajaam:
                            // marker-end at (x2, y2) would be at bottom card.
                            // marker-end at (x1, y1) would be at top card.
                            // Since we draw x1->x2 (Top->Bottom), marker-start is Top, marker-end is Bottom.
                        }
                    } else if (type === 'battery') {
                        if (data.battery.status === 'DISCHARGING') {
                            lineClass = 'flow-line flow-up';
                        } else if (data.battery.status === 'CHARGING') {
                            lineClass = 'flow-line flow-down'; // Red, down (Charge adds to load)
                        }
                    } else {
                        // Consumers (AEG, Rapala) always flow DOWN
                        // Map card types to data keys: 'aeg' -> consumption, 'rapala' -> car
                        if (type === 'aeg' && data.consumption && data.consumption.load > 0) {
                            lineClass = 'flow-line flow-down';
                        } else if (type === 'rapala' && data.car && data.car.load > 0) {
                            lineClass = 'flow-line flow-down';
                        }
                    }
                }

                // Draw line from Top (x1, y1) to Bottom (x2, y2)
                linesHtml += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" class="${lineClass}" />`;

                // Add dots/connector points
                linesHtml += `<circle cx="${x1}" cy="${y1}" r="4" fill="#3b82f6" />`;
                linesHtml += `<circle cx="${x2}" cy="${y2}" r="4" fill="#94a3b8" />`;
            };

            // Draw all 4 lines
            drawLine('card-solar', 'solar', data);
            drawLine('card-battery', 'battery', data);
            drawLine('card-aeg', 'aeg', data);
            drawLine('card-rapala', 'rapala', data); // Uses 'rapala' key but check car load inside helper or pass mapped data

            linesGroup.innerHTML = linesHtml;
        }

        // Handle resize - pass last known data if available, otherwise just redraw structure
        window.addEventListener('resize', () => {
            // We need to access the last data to keep animations correct on resize. 
            // Ideally we store it in a variable.
            // For now, simple redraw without active flow until next fetch or stored state.
            const lastData = window.lastEnergyData;
            updateLines(lastData);
        });

        // Data fetching and updates
        async function fetchEnergyData() {
            try {
                const response = await fetch('/api/energy');
                const result = await response.json();

                if (result.success) {
                    window.lastEnergyData = result.data;
                    updateUI(result.data, result.lastUpdate);
                } else {
                    document.getElementById('status').className = 'status-pill offline';
                    document.getElementById('status').textContent = 'Error';
                }
            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('status').className = 'status-pill offline';
                document.getElementById('status').textContent = 'Connection Lost';
            }
        }

        async function manualRefresh() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            btn.classList.add('refreshing');

            try {
                const response = await fetch('/api/refresh', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    window.lastEnergyData = result.data;
                    updateUI(result.data, result.lastUpdate);
                } else {
                    alert('VÃ¤rskendamine ebaÃµnnestus: ' + (result.message || 'Tundmatu viga'));
                }
            } catch (error) {
                console.error('Refresh error:', error);
                alert('VÃ¤rskendamine ebaÃµnnestus vÃµrguvea tÃµttu.');
            } finally {
                btn.disabled = false;
                btn.classList.remove('refreshing');
            }
        }

        document.getElementById('refresh-btn').addEventListener('click', manualRefresh);

        function updateUI(data, lastUpdate) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('status').className = 'status-pill online';
            document.getElementById('status').textContent = 'Live'; // 'Online';

            // Calculate derived values
            const carLoad = data.car?.load || 0;
            const consumptionLoad = data.consumption?.load || 0;
            const solarLoad = data.solar?.load || 0;
            const batteryLoad = data.battery?.load || 0;
            const batteryStatus = data.battery?.status || 'IDLE';

            // New formula logic based on battery state
            // If Charging: Cons + 2*Car + Battery - Solar (Battery is load, adds to grid load)
            // If Discharging: Cons + 2*Car - Battery - Solar (Battery is source, reduces grid load)
            let alajaamLoad = (consumptionLoad + (2 * carLoad)) - solarLoad;

            if (batteryStatus === 'CHARGING') {
                alajaamLoad += batteryLoad;
                document.querySelector('#card-alajaam .card-formula').textContent = 'Cons + 2Ã—Car + Batt - Solar';
            } else if (batteryStatus === 'DISCHARGING') {
                alajaamLoad -= batteryLoad;
                document.querySelector('#card-alajaam .card-formula').textContent = 'Cons + 2Ã—Car - Batt - Solar';
            } else {
                document.querySelector('#card-alajaam .card-formula').textContent = 'Cons + 2Ã—Car - Solar';
            }

            const aegKilpLoad = consumptionLoad + carLoad;

            // Formatters
            const kw = val => (val / 1000).toFixed(1);
            const curr = val => val?.toFixed(2) || '--';

            // Top Card
            document.getElementById('val-alajaam').textContent = kw(alajaamLoad);

            // Bottom Cards
            document.getElementById('val-solar').textContent = data.solar ? kw(data.solar.load) : '--';
            if (data.solar?.status) {
                const badge = document.getElementById('status-solar');
                badge.textContent = data.solar.status;
                badge.className = `status-badge badge-${data.solar.status.toLowerCase()}`;
            }

            document.getElementById('val-battery').textContent = data.battery ? kw(data.battery.load) : '--';
            document.getElementById('val-soc').textContent = data.battery?.soc || '--';
            if (data.battery?.status) {
                const badge = document.getElementById('status-battery');
                badge.textContent = data.battery.status;
                badge.className = `status-badge badge-${data.battery.status.toLowerCase()}`;
            }

            document.getElementById('val-aeg').textContent = kw(aegKilpLoad);
            document.getElementById('val-rapala').textContent = kw(carLoad);

            // Extras
            document.getElementById('val-mfrr').textContent = curr(data.mfrr) + ' â‚¬';
            document.getElementById('val-grid').textContent = (data.grid ? kw(data.grid.load) : '--') + ' kW';
            // Car is now mapped to Rapala card logic mainly, but we show raw car load in extras
            document.getElementById('val-car').textContent = (data.car ? kw(data.car.load) : '--') + ' kW';
            document.getElementById('val-consumption').textContent = (data.consumption ? kw(data.consumption.load) : '--') + ' kW';

            // Timestamp
            if (lastUpdate) {
                document.getElementById('timestamp').textContent = 'Last updated: ' + new Date(lastUpdate).toLocaleString();
            }

            // Update lines after data render (in case layout shifts) and pass data for animation logic
            requestAnimationFrame(() => updateLines(data));
        }

        // Smart polling with Page Visibility API
        let pollingInterval = null;

        function startPolling() {
            if (pollingInterval) return; // Already running
            console.log('Starting polling...');
            pollingInterval = setInterval(fetchEnergyData, 30000);
        }

        function stopPolling() {
            if (pollingInterval) {
                console.log('Stopping polling (tab hidden)...');
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopPolling();
            } else {
                console.log('Tab visible again, resuming...');
                fetchEnergyData(); // Immediate refresh
                startPolling();
            }
        });

        // Init - only if authenticated
        if (sessionStorage.getItem('authenticated') === 'true') {
            fetchEnergyData();
            startPolling();
        }

        // Initial line draw check
        setTimeout(updateLines, 100);

        // Price Chart functionality
        let priceChart = null;
        let currentHours = 24;

        async function fetchPriceData(hours) {
            try {
                const response = await fetch(`/api/prices?hours=${hours}`);
                const result = await response.json();

                if (result.success) {
                    return result.data;
                }
                return null;
            } catch (error) {
                console.error('Failed to fetch price data:', error);
                return null;
            }
        }

        function renderPriceChart(data) {
            const ctx = document.getElementById('priceChart');

            if (!data) {
                console.log('No chart data available');
                return;
            }

            console.log('Chart data received:', data);

            // Extract Nord Pool data for Estonia
            let nordPoolArray = [];
            if (data.nordpool) {
                if (Array.isArray(data.nordpool)) {
                    nordPoolArray = data.nordpool;
                } else if (data.nordpool.ee) {
                    // Elering API returns {ee: [...], fi: [...], lv: [...], lt: [...]}
                    nordPoolArray = data.nordpool.ee;
                } else if (data.nordpool.data) {
                    nordPoolArray = data.nordpool.data;
                }
            }
            const nordPoolData = (nordPoolArray || []).map(item => ({
                x: new Date(item.timestamp).getTime(),
                y: item.price
            }));

            // Extract mFRR data - handle complex API response structures
            let mfrrArray = [];
            console.log('Inspecting mFRR raw data:', data.mfrr);

            if (data.mfrr) {
                if (Array.isArray(data.mfrr)) {
                    mfrrArray = data.mfrr;
                } else if (data.mfrr.data) {
                    // Check if data.mfrr.data is the array
                    if (Array.isArray(data.mfrr.data)) {
                        mfrrArray = data.mfrr.data;
                    }
                    // Check deeply nested data.mfrr.data.data
                    else if (data.mfrr.data.data && Array.isArray(data.mfrr.data.data)) {
                        mfrrArray = data.mfrr.data.data;
                    }
                    // Check if there is a 'timeseries' property (Baltic API standard format)
                    else if (data.mfrr.data.timeseries && Array.isArray(data.mfrr.data.timeseries)) {
                        console.log('Found mFRR data in timeseries property');
                        mfrrArray = data.mfrr.data.timeseries;
                    }
                    // If it's an object, it might be keyed by the dataset ID (e.g. { "local_marginal_price_mfrr": [...] })
                    else if (typeof data.mfrr.data === 'object' && data.mfrr.data !== null) {
                        const keys = Object.keys(data.mfrr.data);
                        console.log('mFRR.data is an object with keys:', keys);

                        // Try to find the first property that is an array, skipping 'columns'
                        for (const key of keys) {
                            if (key !== 'columns' && Array.isArray(data.mfrr.data[key])) {
                                console.log(`Found array in mFRR.data under key: ${key}`);
                                mfrrArray = data.mfrr.data[key];
                                break;
                            }
                        }
                    }
                }
            }

            // Fallback to empty array if extraction failed to produce an array
            if (!Array.isArray(mfrrArray)) {
                console.warn('Failed to extract mFRR array, defaulting to empty. Value was:', mfrrArray);
                mfrrArray = [];
            } else if (mfrrArray.length > 0) {
                console.log('First mFRR item structure:', mfrrArray[0]);
            }

            const mfrrData = mfrrArray.map(item => ({
                x: new Date(item.start_time || item.timestamp).getTime(),
                y: item.price_up || item.price_down || item.price || 0
            }));

            console.log('Nord Pool data points:', nordPoolData.length);
            console.log('mFRR data points:', mfrrData.length);

            if (nordPoolData.length === 0 && mfrrData.length === 0) {
                console.log('No data points to display');
                return;
            }

            // Destroy existing chart
            if (priceChart) {
                priceChart.destroy();
            }

            // Create new chart
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Nord Pool (â‚¬/MWh)',
                            data: nordPoolData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'mFRR (â‚¬/MWh)',
                            data: mfrrData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    family: 'Inter',
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 13,
                                weight: '600'
                            },
                            bodyFont: {
                                size: 12
                            },
                            callbacks: {
                                title: function (context) {
                                    return new Date(context[0].parsed.x).toLocaleString('et-EE');
                                },
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} â‚¬/MWh`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: currentHours <= 24 ? 'hour' : 'day',
                                displayFormats: {
                                    hour: 'HH:mm',
                                    day: 'dd.MM'
                                }
                            },
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: '#f1f5f9'
                            },
                            ticks: {
                                callback: function (value) {
                                    return value.toFixed(0) + ' â‚¬';
                                },
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        async function updatePriceChart(hours) {
            currentHours = hours;
            const data = await fetchPriceData(hours);
            if (data) {
                renderPriceChart(data);
            }
        }

        // Time range button handlers
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                // Update active state
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Update chart
                const hours = parseInt(btn.dataset.hours);
                await updatePriceChart(hours);
            });
        });

        // Load initial chart when authenticated
        if (sessionStorage.getItem('authenticated') === 'true') {
            updatePriceChart(24);
        }
    </script>
</body>

</html>